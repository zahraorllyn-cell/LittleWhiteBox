<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>剧情地图</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#f7f7f7;--bg2:#fff;--bg3:#f0f0f0;--c:#222;--c2:#666;--c3:#999;--bd:#ddd}
    html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--c)}
    .fc{display:flex;align-items:center}.fcc{display:flex;align-items:center;justify-content:center}.col{flex-direction:column}
    .g4{gap:4px}.g6{gap:6px}.g8{gap:8px}.g10{gap:10px}.g12{gap:12px}
    .p12{padding:12px}.p14{padding:14px}.r4{border-radius:4px}.r6{border-radius:6px}.r50{border-radius:50%}
    .bd{border:1px solid var(--bd)}.bg2{background:var(--bg2)}.bg3{background:var(--bg3)}
    .fs11{font-size:11px}.fs12{font-size:12px}.fs13{font-size:13px}.fs14{font-size:14px}
    .fw5{font-weight:500}.fw6{font-weight:600}.c2{color:var(--c2)}.c3{color:var(--c3)}
    .flex1{flex:1}.shrink0{flex-shrink:0}.ofy{overflow-y:auto}.usn{user-select:none}.trans{transition:all .15s}
    .btn{padding:8px 16px;background:var(--bg2);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;border:1px solid var(--bd);border-radius:4px;color:var(--c)}
    .btn:hover{border-color:var(--c);background:var(--bg3)}
    .btn-p{background:var(--c);color:#fff;border-color:var(--c)}
    .btn-s{padding:6px 12px;font-size:12px}
    .btn-c{width:28px;height:28px;padding:0;background:#888;border-color:#777;color:#fff;border-radius:50%}
    .btn-add{width:32px;height:32px;padding:0;border-radius:50%;flex-shrink:0}
    .fold{background:var(--bg2);border:1px solid var(--bd);border-radius:6px;margin-bottom:8px;overflow:hidden}
    .fold-h{padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .fold-h:hover{background:var(--bg3)}
    .fold-a{transition:transform .2s;color:var(--c3);font-size:10px}
    .fold.exp .fold-a{transform:rotate(180deg)}
    .fold-b{max-height:0;overflow:hidden;transition:all .25s}
    .fold.exp .fold-b{max-height:300px}
    .side-nav,.map-tog{position:fixed;left:10px;z-index:500;background:rgba(255,255,255,.3);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);box-shadow:0 2px 12px rgba(0,0,0,.05);border:1px solid rgba(221,221,221,.3);opacity:.4;transition:opacity .2s,background .2s}
    .side-nav:hover,.map-tog:hover{opacity:1;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);box-shadow:0 2px 12px rgba(0,0,0,.08)}
    .side-nav{top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:4px;padding:8px 5px;border-radius:20px}
    .map-tog{top:calc(50% - 90px);transform:translateY(-50%);padding:5px;border-radius:16px;display:none}
    .map-tog.show{display:block}
    .nav-i,.map-tog-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:50%;transition:all .15s;color:var(--c3)}
    .nav-i i{font-size:13px}
    .nav-i:hover,.map-tog-btn:hover{background:var(--bg3);color:var(--c2)}
    .nav-i.act{background:var(--c);color:#fff}
    .map-tog-btn{border:none;background:transparent}
    .map-tog-btn.in{color:var(--c)}
    .toolbar{height:44px;background:var(--bg2);border-bottom:1px solid var(--bd);padding:0 12px 0 56px}
    .toolbar-t{font-size:14px;font-weight:600;margin-right:auto}
    .toolbar-t span{font-weight:400;color:var(--c3);margin-left:8px;font-size:12px}
    .main-wrap{width:100%;height:calc(100% - 44px);position:relative}
    .page{position:absolute;inset:0;background:var(--bg);display:none;overflow:hidden}
    .page.act{display:block}
    .page-pad{padding:20px 20px 20px 56px;overflow-y:auto;height:100%}
    .banner{width:100%;height:160px;border-radius:8px;overflow:hidden;margin-bottom:20px;position:relative;background:var(--bg3)}
    .banner img{width:100%;height:100%;object-fit:cover;filter:grayscale(30%)}
    .banner-ov{position:absolute;inset:0;background:linear-gradient(transparent 40%,rgba(0,0,0,.5));display:flex;align-items:flex-end;padding:16px}
    .banner-ov div{color:#fff;font-size:13px}
    .sec-t{font-size:12px;color:var(--c3);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
    .news-sec{margin-bottom:24px}
    .news-t{font-size:13px;font-weight:500}
    .news-time{font-size:11px;color:var(--c3)}
    .fold.exp .news-b{padding:0 14px 14px}
    .news-b p{font-size:12px;color:var(--c2);line-height:1.7}
    .prog{padding:14px;background:var(--bg2);border-radius:6px;border:1px solid var(--bd)}
    .prog-bar{height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}
    .prog-fill{height:100%;background:var(--c);border-radius:3px}
    .prog-txt{font-size:11px;color:var(--c3);margin-top:8px;text-align:right}
    #mapWrap{width:100%;height:100%;background:var(--bg);cursor:grab;overflow:hidden;position:relative}
    #inner{position:absolute;width:4000px;height:4000px;transform-origin:0 0}
    #lines{position:absolute;width:4000px;height:4000px;pointer-events:none}
    .item{position:absolute;padding:8px 14px;background:var(--bg3);border:1px solid var(--bd);border-radius:6px;font-size:12px;font-weight:500;white-space:nowrap;cursor:pointer;user-select:none;box-shadow:0 1px 4px rgba(0,0,0,.06);transition:all .15s}
    .item:hover{transform:scale(1.05);box-shadow:0 3px 12px rgba(0,0,0,.1);z-index:10}
    .item.node-main{background:var(--c);color:#fff;border-color:#111}
    .item.node-home{background:#4a5568;color:#fff;border-color:#2d3748}
    .item.node-sub{background:var(--bg2)}
    .item.hl{border-color:#666;box-shadow:0 0 0 3px rgba(0,0,0,.2);z-index:20}
    .map-act{position:absolute;top:10px;right:10px;z-index:100}
    #btn-goto{display:none}
    #btn-goto.show{display:flex}
    .map-lbl{position:absolute;top:10px;left:56px;z-index:100;background:var(--bg2);border:1px solid var(--bd);border-radius:4px;padding:6px 12px;font-size:11px;color:var(--c2)}
    .map-lbl i{margin-right:6px}
    .panel{position:fixed;background:var(--bg2);padding:6px 12px;border-radius:4px;font-size:11px;color:var(--c3);border:1px solid var(--bd)}
    #zoom-ind{bottom:12px;right:12px}
    #tip{bottom:12px;left:56px;right:12px;max-width:400px;padding:12px 14px;line-height:1.6;max-height:180px;overflow-y:auto}
    #tip .desc{color:var(--c2);font-size:12px}
    .loc-lk{color:var(--c);font-weight:500;cursor:pointer;border-bottom:1px dashed var(--c3)}
    #tip.show-i .desc,#tip .info-w{display:none}
    #tip.show-i .info-w{display:block}
    #tip.show-i{border-color:var(--c)}
    .info-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .info-t{font-weight:600;color:var(--c);font-size:13px}
    .info-bk{font-size:11px;color:var(--c3);cursor:pointer;padding:2px 6px;border-radius:3px}
    .info-bk:hover{background:var(--bg3)}
    .info-c{color:var(--c2);font-size:12px;line-height:1.6}
    .comm-hd{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .comm-tabs{display:flex;flex:1}
    .comm-tab{flex:1;padding:10px;text-align:center;background:var(--bg2);border:1px solid var(--bd);cursor:pointer;font-size:12px;font-weight:500;transition:all .15s}
    .comm-tab:first-child{border-radius:6px 0 0 6px}
    .comm-tab:last-child{border-radius:0 6px 6px 0;border-left:none}
    .comm-tab:hover{background:var(--bg3)}
    .comm-tab.act{background:var(--c);color:#fff;border-color:var(--c)}
    .comm-sec{display:none}
    .comm-sec.act{display:block}
    .ct-hd{gap:10px}
    .ct-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:13px;flex-shrink:0}
    .ct-info{flex:1}
    .ct-name{font-size:13px;font-weight:500}
    .ct-st{font-size:11px;color:var(--c3)}
    .ct-det{padding:0 14px 14px}
    .ct-info-text{font-size:12px;color:var(--c2);line-height:1.7;margin:0 0 12px}
    .ct-acts{display:flex;gap:8px}
    .ct-acts .btn{flex:1;justify-content:center;font-size:12px}
    .empty{text-align:center;padding:40px 20px;color:var(--c3);font-size:13px}
    .modal{position:fixed;inset:0;z-index:10000;display:none;justify-content:center;align-items:center}
    .modal.act{display:flex}
    .modal-bd{position:absolute;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px)}
    .modal-p{position:relative;width:90%;max-width:700px;max-height:85vh;background:var(--bg2);border:1px solid var(--bd);border-radius:8px;overflow:hidden;display:flex;flex-direction:column}
    .modal-p.sm{max-width:360px}
    .modal-p.lg{max-width:560px}
    .modal-hd,.modal-ft{padding:14px 18px}
    .modal-hd{justify-content:space-between;border-bottom:1px solid var(--bd)}
    .modal-hd h2{font-size:14px;font-weight:600}
    .modal-ft{justify-content:flex-end;gap:10px;border-top:1px solid var(--bd)}
    .modal-x{width:28px;height:28px;background:transparent;cursor:pointer;border:1px solid var(--bd);border-radius:4px}
    .modal-x:hover{background:var(--bg3)}
    .modal-by{flex:1;overflow-y:auto;padding:18px}
    .ed-sec .fold-h{background:var(--bg3)}
    .ed-sec.exp .fold-b{max-height:400px}
    .ed-ta{width:100%;min-height:200px;padding:12px;background:var(--bg);border:none;border-top:1px solid var(--bd);font-family:'SF Mono',Monaco,Consolas,monospace;font-size:11px;line-height:1.5;color:var(--c);resize:none;outline:none}
    .ed-preview{margin-top:10px;padding:10px;background:var(--bg3);border:1px solid var(--bd);border-radius:4px;font-size:11px;font-family:'SF Mono',Monaco,Consolas,monospace;white-space:pre-wrap;display:none;color:var(--c2)}
    .ed-err{padding:10px;background:#fef2f2;border:1px solid #fecaca;border-radius:4px;color:#b91c1c;font-size:12px;margin-top:10px;display:none}
    .ed-err.vis{display:block}
    .form-g{margin-bottom:14px}
    .form-l{display:block;font-size:12px;font-weight:500;margin-bottom:6px;color:var(--c2)}
    .form-in{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:4px;font-size:13px;outline:none;background:var(--bg2)}
    .form-ta{min-height:80px;resize:vertical;font-family:inherit}
    .goto-d{font-size:13px;color:var(--c);font-weight:500;padding:10px 14px;background:var(--bg3);border-radius:4px;margin-bottom:14px}
    .chat{position:fixed;top:0;right:-400px;width:300px;height:100%;background:var(--bg2);border-left:1px solid var(--bd);z-index:600;display:flex;flex-direction:column;transition:right .3s}
    .chat.act{right:0}
    .chat-hd{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:12px;flex-shrink:0}
    .chat-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:13px}
    .chat-t{flex:1}
    .chat-nm{font-size:14px;font-weight:600}
    .chat-st{font-size:11px;color:var(--c3)}
    .chat-hd-acts{display:flex;align-items:center;gap:4px}
    .chat-compress,.chat-clr,.chat-x{width:32px;height:32px;border:none;background:transparent;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--c3)}
    .chat-compress:hover,.chat-clr:hover,.chat-x:hover{background:var(--bg3);color:var(--c)}
    .chat-compress:hover{color:#3498db}
    .chat-compress:disabled{opacity:.4;cursor:not-allowed}
    .chat-clr:hover{color:#e74c3c}
    .chat-divider{width:100%;text-align:center;padding:8px 0;color:var(--c3);font-size:11px;position:relative}
    .chat-divider::before,.chat-divider::after{content:'';position:absolute;top:50%;width:30%;height:1px;background:var(--bd)}
    .chat-divider::before{left:0}
    .chat-divider::after{right:0}
    .chat-msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
    .chat-msg{max-width:80%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;white-space:pre-wrap}
    .chat-msg.sent{align-self:flex-end;background:var(--c);color:#fff;border-bottom-right-radius:4px}
    .chat-msg.recv{align-self:flex-start;background:var(--bg3);border-bottom-left-radius:4px}
    .chat-msg.typing{font-style:italic;opacity:.7}
    .chat-in-w{padding:12px;border-top:1px solid var(--bd);display:flex;gap:10px;flex-shrink:0}
    .chat-in{flex:1;padding:10px 14px;border:1px solid var(--bd);border-radius:20px;font-size:13px;outline:none;background:var(--bg)}
    .chat-in:focus{border-color:var(--c)}
    .chat-in:disabled,.chat-send:disabled{opacity:.5;cursor:not-allowed}
    .chat-send{width:36px;height:36px;border:none;background:var(--c);color:#fff;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .chat-send:hover{opacity:.9}
    .chat-emp{text-align:center;color:var(--c3);font-size:12px;padding:40px 20px}
    .loc-list{max-height:300px;overflow-y:auto}
    .loc-i{padding:12px 14px;border:1px solid var(--bd);border-radius:6px;margin-bottom:8px;cursor:pointer;transition:all .15s}
    .loc-i:hover{border-color:var(--c);background:var(--bg3)}
    .loc-i.sel{border-color:var(--c);background:var(--c);color:#fff}
    .loc-i-nm{font-size:13px;font-weight:500}
    .loc-i-info{font-size:11px;opacity:.7;margin-top:2px}
    .mob-pop{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--bd);border-radius:12px 12px 0 0;box-shadow:0 -2px 16px rgba(0,0,0,.1);z-index:200;display:none;flex-direction:column}
    .mob-pop.act{display:flex}
    .mob-pop.drag{transition:none!important}
    .mob-pop:not(.drag){transition:height .2s ease-out}
    .pop-hd{padding:12px 20px 8px;cursor:grab;touch-action:none;flex-shrink:0}
    .pop-handle{width:36px;height:4px;background:var(--bd);border-radius:2px;margin:0 auto}
    .pop-ct{flex:1;overflow-y:auto;padding:0 20px 20px;-webkit-overflow-scrolling:touch}
    .pop-desc{color:var(--c2);font-size:13px;line-height:1.7}
    .pop-info{display:none}
    .mob-pop.show-i .pop-desc{display:none}
    .mob-pop.show-i .pop-info{display:block}
    .pop-info-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .pop-info-t{font-weight:600;font-size:14px}
    .pop-info-bk{font-size:12px;color:var(--c3);cursor:pointer;padding:4px 8px;border-radius:4px}
    .pop-h-ind{position:absolute;top:50%;right:6px;transform:translateY(-50%);display:flex;flex-direction:column;gap:3px;opacity:0;transition:opacity .15s}
    .mob-pop.drag .pop-h-ind{opacity:1}
    .pop-h-ind span{width:3px;height:8px;background:var(--bd);border-radius:1px}
    .pop-h-ind span.act{background:var(--c)}
    .set-sec{margin-bottom:16px}
    .set-sec-t{font-size:13px;font-weight:600;color:var(--c);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bd)}
    .set-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .set-row .form-in{flex:1}
    .set-row .btn{flex-shrink:0}
    .set-hint{font-size:11px;color:var(--c3);margin-top:4px}
    .set-test{display:flex;align-items:center;gap:8px;margin-top:8px}
    .set-test-res{font-size:12px;padding:6px 10px;border-radius:4px;display:none}
    .set-test-res.ok{display:block;background:#dcfce7;color:#166534;border:1px solid #86efac}
    .set-test-res.err{display:block;background:#fef2f2;color:#b91c1c;border:1px solid #fecaca}
    .data-item{display:flex;align-items:flex-start;gap:10px;padding:12px;background:var(--bg);border:1px solid var(--bd);border-radius:6px;margin-bottom:8px;cursor:pointer;transition:all .15s}
    .data-item:hover{border-color:var(--c2);background:var(--bg3)}
    .data-item.sel{border-color:var(--c);background:rgba(34,34,34,.05)}
    .data-ck{width:18px;height:18px;border:2px solid var(--bd);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;margin-top:2px}
    .data-item.sel .data-ck{background:var(--c);border-color:var(--c);color:#fff}
    .data-ck i{font-size:10px;opacity:0}
    .data-item.sel .data-ck i{opacity:1}
    .data-info{flex:1;min-width:0}
    .data-nm{font-size:13px;font-weight:500;margin-bottom:4px}
    .data-desc{font-size:11px;color:var(--c3);line-height:1.4}
    .data-edit{width:28px;height:28px;border:1px solid var(--bd);border-radius:4px;background:var(--bg2);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;color:var(--c3)}
    .data-edit:hover{border-color:var(--c);color:var(--c);background:var(--bg3)}
    @media(max-width:768px){.chat{width:100%;right:-100%}}
    @media(max-width:480px){
      .side-nav{left:6px;padding:6px 4px}
      .nav-i{width:28px;height:28px}
      .nav-i i{font-size:11px}
      .map-tog{left:6px;top:calc(50% - 75px)}
      .map-tog-btn{width:28px;height:28px}
      .toolbar{padding:0 10px 0 48px}
      .toolbar-t span{display:none}
      .btn{padding:6px 10px;font-size:11px}
      .modal-p{max-width:100%;max-height:100%;border-radius:0}
      #tip{display:none}
      .page-pad{padding:14px 14px 14px 48px}
      .map-lbl{left:48px}
    }
  </style>
</head>
<body>
  <div class="map-tog show" id="map-tog"><button class="map-tog-btn" id="btn-tog"><i class="fa-solid fa-expand"></i></button></div>
  <nav class="side-nav">
    <div class="nav-i" data-p="world"><i class="fa-solid fa-earth-americas"></i></div>
    <div class="nav-i act" data-p="map"><i class="fa-solid fa-map"></i></div>
    <div class="nav-i" data-p="comm"><i class="fa-solid fa-phone"></i></div>
  </nav>
  <div class="toolbar fc g10 usn">
    <div class="toolbar-t">剧情地图<span>Story Outline</span></div>
    <button class="btn btn-s fc g6" id="btn-deduce"><i class="fa-solid fa-wand-magic-sparkles"></i>世界生成</button>
    <button class="btn btn-s fc g6" id="btn-simulate"><i class="fa-solid fa-rotate"></i>世界推演</button>
    <button class="btn btn-s fc g6" id="btn-settings"><i class="fa-solid fa-gear"></i>设置</button>
    <button class="btn btn-c fcc" id="btn-close">✕</button>
  </div>
  <div class="main-wrap">
    <div class="page page-pad" id="page-world">
      <div class="banner"><img src="https://picsum.photos/800/300" alt=""><div class="banner-ov"><div>探索未知的世界...</div></div></div>
      <div class="news-sec"><h3 class="sec-t">最新消息</h3><div id="news-list"></div></div>
      <div class="prog"><h3 class="sec-t">主线进度</h3><div class="prog-bar"><div class="prog-fill" id="prog-fill"></div></div><div class="prog-txt" id="prog-txt"></div></div>
    </div>
    <div class="page act" id="page-map">
      <div id="mapWrap">
        <div class="map-lbl"><i class="fa-solid fa-map-location-dot"></i><span id="map-lbl-t">大地图</span></div>
        <div class="map-act"><button class="btn btn-s btn-p fc g6" id="btn-goto"><i class="fa-solid fa-location-arrow"></i><span id="goto-t">前往</span></button></div>
        <div id="inner"><svg id="lines"></svg></div>
      </div>
      <div class="panel" id="zoom-ind">100%</div>
      <div class="panel" id="tip"><div class="desc" id="desc"></div><div class="info-w"><div class="info-h"><div class="info-t" id="info-t"></div><div class="info-bk" id="info-bk">← 返回</div></div><div class="info-c" id="info-c"></div></div></div>
    </div>
    <div class="page page-pad" id="page-comm">
      <div class="comm-hd">
        <div class="comm-tabs"><div class="comm-tab act" data-t="stranger">陌路人</div><div class="comm-tab" data-t="contact">联络人</div></div>
        <button class="btn btn-add fcc" id="btn-refresh-strangers" title="摇一摇，与陌路人相遇"><i class="fa-solid fa-rotate"></i></button>
        <button class="btn btn-add fcc" id="btn-add-ct"><i class="fa-solid fa-plus"></i></button>
      </div>
      <div id="sec-stranger" class="comm-sec act"></div>
      <div id="sec-contact" class="comm-sec"></div>
    </div>
  </div>
  <div class="chat" id="chat">
    <div class="chat-hd">
      <div class="chat-av" id="chat-av"></div>
      <div class="chat-t"><div class="chat-nm" id="chat-nm"></div><div class="chat-st" id="chat-st"></div></div>
      <div class="chat-hd-acts"><button class="chat-compress" id="chat-compress" title="压缩总结历史消息"><i class="fa-solid fa-compress"></i></button><button class="chat-clr" id="chat-clr" title="清空聊天记录"><i class="fa-solid fa-trash"></i></button><button class="chat-x" id="chat-x"><i class="fa-solid fa-xmark"></i></button></div>
    </div>
    <div class="chat-msgs" id="chat-msgs"></div>
    <div class="chat-in-w"><input type="text" class="chat-in" id="chat-in" placeholder="输入消息..."><button class="chat-send" id="chat-send"><i class="fa-solid fa-paper-plane"></i></button></div>
  </div>
  <div class="mob-pop" id="mob-pop">
    <div class="pop-h-ind"><span data-l="2"></span><span data-l="1"></span><span data-l="0"></span></div>
    <div class="pop-hd" id="pop-hd"><div class="pop-handle"></div></div>
    <div class="pop-ct"><div class="pop-desc" id="mob-desc"></div><div class="pop-info"><div class="pop-info-h"><div class="pop-info-t" id="mob-info-t"></div><div class="pop-info-bk" id="mob-info-bk">← 返回</div></div><div id="mob-info-c"></div></div></div>
  </div>
  <div class="modal" id="m-settings"><div class="modal-bd"></div><div class="modal-p lg"><div class="modal-hd fc"><h2>设置</h2><button class="modal-x fcc">✕</button></div><div class="modal-by">
    <div class="set-sec"><div class="set-sec-t">剧情状态</div><div class="set-row" style="gap:20px;margin-bottom:16px"><div class="form-g" style="flex:1"><label class="form-l">当前阶段 (Stage)</label><input type="number" class="form-in" id="set-stage" min="0" max="10" value="0"><div class="set-hint">决定可见的洋葱层级 (L1-L7)</div></div><div class="form-g" style="flex:1"><label class="form-l">偏离分数 (Deviation)</label><input type="number" class="form-in" id="set-deviation" min="0" max="100" value="0"><div class="set-hint">玩家行为对世界的影响程度</div></div></div></div>
    <div class="set-sec"><div class="set-sec-t">模式设置</div><div class="form-g"><label class="form-l">运行模式</label><select class="form-in" id="set-mode"><option value="story">故事模式（包含世界大纲与时间线）</option><option value="assist">辅助模式（只生成地图/新闻/轻松小剧情，不写大纲与时间线）</option></select><div class="set-hint">可在游玩过程中自由切换，仅影响后续的世界生成、世界推演与场景切换所使用的提示词和模板。</div></div></div>
    <div class="set-sec"><div class="set-sec-t">全局设定</div><div class="form-g"><label class="form-l">API端点（只支持OpenAI格式）</label><input type="text" class="form-in" id="set-api-url" placeholder="留空则使用当前酒馆的API"><div class="set-hint">例如: https://api.openai.com/v1</div></div><div class="form-g"><label class="form-l">API密钥</label><input type="password" class="form-in" id="set-api-key" placeholder="输入API密钥"></div><div class="form-g"><label class="form-l">模型</label><div class="set-row"><input type="text" class="form-in" id="set-model" placeholder="输入模型名称"><button class="btn btn-s" id="btn-fetch-models">获取</button><button class="btn btn-s btn-p" id="btn-test-conn">测试连接</button></div><select class="form-in" id="set-model-list" style="display:none;margin-top:8px"></select></div><div class="set-test"><label class="form-l">聊天历史楼层数</label><input type="number" class="form-in" id="set-history-count" min="0" max="200" value="50" style="width:100px"><div class="set-test-res" id="test-res"></div></div><div class="set-sec-t" style="margin-top:16px">NPC 世界书条目</div><div class="form-g"><label class="form-l">插入位置</label><select class="form-in" id="set-npc-position"><option value="0">↑Char 角色定义前</option><option value="1">↓Char 角色定义后</option><option value="2">↑AN 作者注释前</option><option value="3">↓AN 作者注释后</option><option value="5">↑EM 增强定义前</option><option value="6">↓EM 增强定义后</option></select><div class="set-hint">生成的NPC角色卡世界书条目的插入位置</div></div><div class="form-g"><label class="form-l">条目顺序</label><input type="number" class="form-in" id="set-npc-order" min="0" max="1000" value="100" style="width:120px"><div class="set-hint">数值越小越靠前（范围：0-1000）</div></div></div>
    <div class="set-sec"><div class="set-sec-t">预设 Story Outline 数据</div><div class="set-hint" style="margin-bottom:12px">勾选的条目将写入预设的 Story Outline 中</div><div id="data-list"></div></div>
    <div class="set-sec"><div class="set-sec-t">高级设置 · 自定义提示词</div><div class="set-hint" style="margin-bottom:12px">默认模板取自 story-outline-prompt.js，修改后会保存到酒馆本地存储（UAUA四段 + JSON 模板）。</div><div id="prompt-list"></div></div>
  </div><div class="modal-ft fc"><button class="btn btn-s m-cancel">取消</button><button class="btn btn-s btn-p" id="set-save">保存</button></div></div></div>
  <div class="modal" id="m-data-edit"><div class="modal-bd"></div><div class="modal-p"><div class="modal-hd fc"><h2 id="data-edit-title">编辑数据</h2><button class="modal-x fcc">✕</button></div><div class="modal-by"><textarea class="ed-ta" id="data-edit-ta" style="min-height:300px"></textarea><pre class="ed-preview" id="data-edit-preview"></pre><div class="ed-err" id="data-edit-err"></div></div><div class="modal-ft fc"><button class="btn btn-s m-cancel">取消</button><button class="btn btn-s btn-p" id="data-edit-save">保存</button></div></div></div>
  <div class="modal" id="m-goto"><div class="modal-bd"></div><div class="modal-p sm"><div class="modal-hd fc"><h2>确认前往</h2><button class="modal-x fcc">✕</button></div><div class="modal-by"><div class="goto-d" id="goto-d"></div><div class="form-g"><label class="form-l">任务目标（可选）</label><textarea class="form-in form-ta" id="goto-task" placeholder="描述你要做什么..."></textarea></div></div><div class="modal-ft fc"><button class="btn btn-s m-cancel">取消</button><button class="btn btn-s btn-p" id="goto-ok">确认前往</button></div></div></div>
  <div class="modal" id="m-invite"><div class="modal-bd"></div><div class="modal-p sm"><div class="modal-hd fc"><h2>邀请前往</h2><button class="modal-x fcc">✕</button></div><div class="modal-by"><div class="goto-d" id="inv-t"></div><div class="form-g"><label class="form-l">选择地点</label><div class="loc-list" id="loc-list"></div></div></div><div class="modal-ft fc"><button class="btn btn-s m-cancel">取消</button><button class="btn btn-s btn-p" id="inv-ok">发送邀请</button></div></div></div>
  <div class="modal" id="m-world-gen"><div class="modal-bd"></div><div class="modal-p"><div class="modal-hd fc"><h2>世界生成</h2><button class="modal-x fcc">✕</button></div><div class="modal-by"><div class="form-g"><label class="form-l">玩家特殊需求（可选）</label><textarea class="form-in form-ta" id="world-gen-req" rows="4" placeholder="例如：希望有更多悬疑元素、增加一个神秘组织、主角是侦探..."></textarea><div class="set-hint">AI 会根据当前世界观和你的需求生成完整的世界数据</div></div><div id="world-gen-status" class="set-hint" style="color:#4a9;display:none"></div></div><div class="modal-ft fc"><button class="btn btn-s m-cancel">取消</button><button class="btn btn-s btn-p" id="world-gen-ok"><i class="fa-solid fa-wand-magic-sparkles"></i> 开始生成</button></div></div></div>
  <div class="modal" id="m-world-sim"><div class="modal-bd"></div><div class="modal-p"><div class="modal-hd fc"><h2>世界推演</h2><button class="modal-x fcc">✕</button></div><div class="modal-by"><div class="form-g"><div class="set-hint" style="margin-bottom:12px;"><strong>推演模式</strong>：根据玩家行为和时间流逝，演化世界状态。<ul style="margin:8px 0;padding-left:20px;font-size:12px;"><li>L1/L2（表象/痕迹）将大幅更新</li><li>L3/L4（机制/节点）适度调整</li><li>L5/L6/L7（核心）保持不变</li><li>约30%的次级地点可能变化</li><li>Stage 将推进到下一阶段</li></ul></div><div class="set-hint" style="color:#f80;">⚠️ 注意：此操作会覆盖当前的世界数据，建议先备份</div></div><div id="world-sim-status" class="set-hint" style="color:#4a9;display:none"></div></div><div class="modal-ft fc"><button class="btn btn-s m-cancel">取消</button><button class="btn btn-s btn-p" id="world-sim-ok"><i class="fa-solid fa-rotate"></i> 开始推演</button></div></div></div>
  <div class="modal" id="m-add-ct"><div class="modal-bd"></div><div class="modal-p sm"><div class="modal-hd fc"><h2>添加联络人</h2><button class="modal-x fcc">✕</button></div><div class="modal-by"><div class="form-g"><label class="form-l">UID（世界书条目UID）</label><div class="set-row"><input type="text" class="form-in" id="add-uid" placeholder="请输入世界书条目UID"><button class="btn btn-s" id="btn-check-uid"><i class="fa-solid fa-search"></i> 检查</button></div><div class="set-hint">输入角色卡绑定世界书的条目UID</div></div><div class="form-g" id="name-select-group" style="display:none"><label class="form-l">选择名字（主要关键字）</label><select class="form-in" id="add-name"><option value="">-- 请选择 --</option></select></div><div id="uid-check-err" class="ed-err"></div></div><div class="modal-ft fc"><button class="btn btn-s m-cancel">取消</button><button class="btn btn-s btn-p" id="add-ct-ok" disabled>确定</button></div></div></div>
<script>
const WORLD={news:[{title:"市政广场举办秋季市集",time:"3小时前",type:"main",content:"一年一度的秋季市集盛大开幕，各地商贩云集。"},{title:"北城门加强戒备",time:"昨天",type:"main",content:"由于近期北方荒野出现异常活动，北城门已加派守卫巡逻。"},{title:"渔村码头发现古老遗迹",time:"2天前",type:"sub",content:"渔民在码头附近的海底发现了疑似古代文明遗迹。"}],progress:{chapter:"第一章 · 觉醒",percent:35}};
const MAP_OUTDOOR={name:"大地图",description:"你站在城市的中心。向东是[[市政广场]]与[[东商业街]]，东南可达[[河畔集市]]和[[渔村码头]]。北面是[[北城门]]，城外是[[北丘陵]]和[[猎人营地]]。西边是[[西铁匠铺]]和[[西树林]]。南郊是[[南郊农田]]和[[果园小屋]]。西北矗立着废弃的[[旧瞭望塔]]。你的[[家]]在城中一隅。",nodes:[{name:"家",position:"south",distant:1,type:"home",info:"你温馨的小屋，一切冒险的起点与归宿。"},{name:"市政广场",position:"east",distant:1,type:"main",info:"城市心脏，宽阔石板广场上矗立着古老喷泉。"},{name:"北城门",position:"north",distant:2,type:"main",info:"厚重橡木城门，两侧高耸石砌城墙。"},{name:"北丘陵",position:"northwest",distant:3,type:"sub",info:"起伏丘陵覆盖茂密灌木野草。"},{name:"猎人营地",position:"northeast",distant:3,type:"sub",info:"皮革帐篷围成一圈，中央篝火熊熊。"},{name:"东商业街",position:"east",distant:1,type:"main",info:"街道两旁店铺林立，应有尽有。"},{name:"河畔集市",position:"east",distant:2,type:"main",info:"沿河露天市场，摊位延伸到水边。"},{name:"渔村码头",position:"southeast",distant:3,type:"sub",info:"简陋木质码头延伸入平静河水。"},{name:"南郊农田",position:"south",distant:2,type:"main",info:"一望无际农田闪耀金色光芒。"},{name:"果园小屋",position:"southwest",distant:3,type:"sub",info:"果树环绕的小木屋，屋顶爬满常春藤。"},{name:"西铁匠铺",position:"west",distant:1,type:"main",info:"炉火熊熊，铁锤敲击声有节奏响起。"},{name:"西树林",position:"west",distant:2,type:"sub",info:"高大橡树遮天蔽日，光影斑驳。"},{name:"旧瞭望塔",position:"northwest",distant:4,type:"sub",info:"废弃石制瞭望塔，墙壁爬满青苔藤蔓。"}]};
const MAP_INDOOR={name:"酒馆内部",description:"推开[[入口]]木门，麦酒烤肉香气扑面。正前方是[[吧台]]，左侧有[[角落座位]]，右边是[[壁炉旁]]，北侧通往[[储藏室]]，东北是[[楼梯口]]。",nodes:[{name:"入口",position:"south",distant:1,type:"main",info:"厚重橡木门装着黄铜把手。"},{name:"吧台",position:"north",distant:1,type:"main",info:"橡木吧台被岁月打磨得油光锃亮。"},{name:"角落座位",position:"southwest",distant:2,type:"sub",info:"屏风酒桶半遮掩的隐蔽角落。"},{name:"壁炉旁",position:"east",distant:2,type:"sub",info:"石砌壁炉火焰跳动，温暖辐射。"},{name:"楼梯口",position:"northeast",distant:2,type:"sub",info:"通往二楼的木制楼梯。"},{name:"储藏室",position:"northwest",distant:2,type:"sub",info:"木门后堆满酒桶物资的储藏室。"}]};
const STRANGERS=[{name:'神秘商人',avatar:'神',color:'#999',location:'市政广场',info:'来自北方的神秘商人，总戴着兜帽。'},{name:'老猎人',avatar:'猎',color:'#777',location:'猎人营地',info:'北方荒野狩猎三十年的老猎人。'},{name:'渔村少女',avatar:'渔',color:'#888',location:'渔村码头',info:'渔村长大的活泼少女。'}];
const CONTACTS=[{name:'炒饭智能',avatar:'炒',color:'#555',location:'在线',info:'你的智能助手，随时待命。',online:true,worldbookUid:'',messages:[{type:'received',text:'你好！有什么可以帮助你的？',time:'10:30'}],summarizedCount:0}];
const D={stage:0,deviationScore:0,meta:null,timeline:null,world:WORLD,maps:{outdoor:MAP_OUTDOOR,indoor:MAP_INDOOR},sceneSetup:null,contacts:{strangers:STRANGERS,contacts:CONTACTS}};
const $=id=>document.getElementById(id),$$=s=>document.querySelectorAll(s),isMob=()=>innerWidth<=768;
const dirMap={north:[0,-1],south:[0,1],east:[1,0],west:[-1,0],northeast:[1,-1],northwest:[-1,-1],southeast:[1,1],southwest:[-1,1]};

// 通用工具函数
const post=(type,data={})=>parent.postMessage({source:'LittleWhiteBox-OutlineFrame',type,...data},'*');
const BtnState={
  load:(btn,t)=>{btn.disabled=true;btn._o=btn.innerHTML;btn.innerHTML=`<i class="fa-solid fa-spinner fa-spin"></i> ${t}`},
  reset:(btn,t)=>{btn.disabled=false;btn.innerHTML=t||btn._o}
};
const Req={
  _p:{},_id:0,
  create(k){const id=k+'_'+(++this._id);this._p[k]={id};return id},
  get(k){return this._p[k]},
  match(id){const k=id.split('_')[0];return this._p[k]?.id===id?this._p[k]:null},
  set(k,d){Object.assign(this._p[k]||{},d)},
  clear(k){delete this._p[k]}
};
const escHtml=s=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
const stripXml=s=>{if(!s)return'';let r=s,p='';while(r!==p){p=r;r=r.replace(/<(\w+)[^>]*>[\s\S]*?<\/\1>/g,'')}return r.replace(/<[^>]+\/?>/g,'').trim()};
const parseLinks=t=>t.replace(/\[\[([^\]]+)\]\]/g,'<span class="loc-lk" data-loc="$1">$1</span>');
const bindLinks=el=>el.querySelectorAll('.loc-lk').forEach(l=>l.onclick=e=>{e.stopPropagation();const n=nodes.find(x=>x.name===l.dataset.loc);if(n){panTo(n);showInfo(n)}});
const bindFold=el=>el.querySelector('.fold-h').onclick=()=>el.classList.toggle('exp');
const openM=id=>$(id).classList.add('act'),closeM=id=>$(id).classList.remove('act');
$$('.modal-bd,.modal-x,.m-cancel').forEach(el=>el.onclick=()=>el.closest('.modal').classList.remove('act'));

let mapType='outdoor',curNode=null,curLocation=null,drag=false,scale=1,offX=0,offY=0,seed=123456789,nodes=[],lines=[],anim=false,chatTgt=null,invTgt=null,selLoc=null;
const rand=()=>(seed=(seed*9301+49297)%233280)/233280;
const inner=$("inner"),svg=$("lines"),mapWrap=$("mapWrap"),popup=$('mob-pop'),chat=$('chat');

// 弹出面板相关
const snaps=()=>[120,innerHeight*.35,innerHeight*.7];
let popH=0,popDrag=false,popSY=0,popSH=0,popLv=1;
const inds=popup.querySelectorAll('.pop-h-ind span');
const setPopH=h=>{const s=snaps();popH=Math.max(s[0],Math.min(innerHeight*.85,h));popup.style.height=popH+'px';popLv=s.map((v,i)=>[i,Math.abs(popH-v)]).sort((a,b)=>a[1]-b[1])[0][0];inds.forEach((x,i)=>x.classList.toggle('act',i===popLv))};
const snapTo=l=>{popLv=Math.max(0,Math.min(2,l));setPopH(snaps()[popLv])};
const openPop=(l=1)=>{popup.classList.add('act');snapTo(l)};
const setupPopDrag=(el,isMouse)=>{
  const start=e=>{popDrag=true;popSY=isMouse?e.clientY:e.touches[0].clientY;popSH=popH||snaps()[1];popup.classList.add('drag');isMouse&&e.preventDefault()};
  const move=e=>{if(popDrag)setPopH(popSH+popSY-(isMouse?e.clientY:e.touches[0].clientY))};
  const end=()=>{if(!popDrag)return;popDrag=false;popup.classList.remove('drag');snapTo(popLv)};
  el[isMouse?'onmousedown':'ontouchstart']=start;
  document[isMouse?'onmousemove':'ontouchmove']=move;
  document[isMouse?'onmouseup':'ontouchend']=end;
};
setupPopDrag($('pop-hd'),false);setupPopDrag($('pop-hd'),true);

// 聊天功能
let smsGen=false;
const openChat=c=>{chatTgt=c;$('chat-av').textContent=c.avatar;$('chat-av').style.background=c.color;$('chat-nm').textContent=c.name;$('chat-st').textContent=c.online?'● 在线':c.location;if(c.worldbookUid&&(!c.messages||!c.messages.length))post('LOAD_SMS_HISTORY',{worldbookUid:c.worldbookUid});else renderMsgs();chat.classList.add('act');$('chat-in').focus()};
const closeChat=()=>{chat.classList.remove('act');chatTgt=null;smsGen=false};
const renderMsgs=()=>{if(!chatTgt)return;const m=chatTgt.messages||[],sc=chatTgt.summarizedCount||0;let h='';if(m.length){m.forEach((x,i)=>{if(sc>0&&i===sc)h+='<div class="chat-divider">—— 以上为已总结消息 ——</div>';h+=`<div class="chat-msg ${x.type==='sent'?'sent':'recv'}${x.typing?' typing':''}"><div>${escHtml(stripXml(x.text))}</div></div>`})}else h='<div class="chat-emp">暂无消息，开始聊天吧</div>';$('chat-msgs').innerHTML=h;$('chat-msgs').scrollTop=$('chat-msgs').scrollHeight;$('chat-compress').disabled=(m.length-sc)<2||smsGen};
const sendMsg=()=>{const t=$('chat-in').value.trim();if(!t||!chatTgt||smsGen)return;chatTgt.messages=chatTgt.messages||[];chatTgt.messages.push({type:'sent',text:t});$('chat-in').value='';renderMsgs();smsGen=true;$('chat-in').disabled=$('chat-send').disabled=true;chatTgt.messages.push({type:'received',text:'正在输入...',typing:true});renderMsgs();const id=Req.create('sms');Req.set('sms',{tgt:chatTgt});post('SEND_SMS',{requestId:id,contactName:chatTgt.name,worldbookUid:chatTgt.worldbookUid,userMessage:t,chatHistory:chatTgt.messages.filter(m=>!m.typing).slice(-20)})};
const saveCt=()=>post('SAVE_CONTACTS',{contacts:D.contacts.contacts,strangers:D.contacts.strangers});
const saveChat=c=>post('SAVE_SMS_HISTORY',{worldbookUid:c.worldbookUid,contactName:c.name,messages:c.messages.filter(m=>!m.typing),summarizedCount:c.summarizedCount||0});
$('chat-x').onclick=closeChat;
$('chat-clr').onclick=()=>{if(!chatTgt||!confirm(`确定要清空与 ${chatTgt.name} 的所有聊天记录吗？`))return;chatTgt.messages=[];chatTgt.summarizedCount=0;renderMsgs();saveCt();if(chatTgt.worldbookUid)saveChat(chatTgt)};
$('chat-compress').onclick=()=>{if(!chatTgt||smsGen)return;const m=chatTgt.messages||[],sc=chatTgt.summarizedCount||0,um=m.slice(sc);if(um.length<2){alert('至少需要2条未总结的消息才能压缩');return}if(!confirm(`确定要压缩总结 ${um.length} 条消息吗？`))return;smsGen=true;$('chat-compress').disabled=$('chat-in').disabled=$('chat-send').disabled=true;const id=Req.create('compress');Req.set('compress',{tgt:chatTgt});post('COMPRESS_SMS',{requestId:id,contactName:chatTgt.name,worldbookUid:chatTgt.worldbookUid,messages:m.filter(x=>!x.typing),summarizedCount:sc})};
$('chat-send').onclick=sendMsg;
const chatIn=$('chat-in');['keydown','keypress','keyup'].forEach(e=>chatIn.addEventListener(e,ev=>ev.stopPropagation()));
chatIn.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg()}});

// 邀请功能
const openInv=c=>{invTgt=c;selLoc=null;$('inv-t').textContent=`邀请：${c.name}`;$('loc-list').innerHTML=D.maps.outdoor.nodes.map(l=>`<div class="loc-i" data-n="${l.name}"><div class="loc-i-nm">${l.name}</div><div class="loc-i-info">${l.info||''}</div></div>`).join('');$$('#loc-list .loc-i').forEach(i=>i.onclick=()=>{$$('#loc-list .loc-i').forEach(x=>x.classList.remove('sel'));i.classList.add('sel');selLoc=i.dataset.n});openM('m-invite')};
$('inv-ok').onclick=()=>{if(!selLoc||!invTgt)return;const btn=$('inv-ok');BtnState.load(btn,'询问中...');const id=Req.create('invite');Req.set('invite',{contact:invTgt,loc:selLoc,btn});post('SEND_INVITE',{requestId:id,contactName:invTgt.name,contactUid:invTgt.worldbookUid,targetLocation:selLoc,smsHistory:(invTgt.messages||[]).map(m=>m.type==='sent'?`{{user}}: ${m.text}`:`${invTgt.name}: ${m.text}`).join('\n'),userLocation:curLocation?.name||''})};

// 添加联络人
let addCtState={uid:'',name:'',keys:[]};
const resetAddCt=()=>{addCtState={uid:'',name:'',keys:[]};$('add-uid').value='';$('add-name').value='';$('add-name').innerHTML='<option value="">-- 请选择 --</option>';$('name-select-group').style.display='none';$('uid-check-err').classList.remove('vis');$('add-ct-ok').disabled=true;BtnState.reset($('btn-check-uid'),'<i class="fa-solid fa-search"></i> 检查')};
const showUidErr=m=>{$('uid-check-err').textContent=m;$('uid-check-err').classList.add('vis')};
$('btn-check-uid').onclick=()=>{const uid=$('add-uid').value.trim();if(!uid){showUidErr('请输入UID');return}$('uid-check-err').classList.remove('vis');BtnState.load($('btn-check-uid'),'检查中');$('name-select-group').style.display='none';$('add-ct-ok').disabled=true;addCtState.uid=uid;const id=Req.create('uidck');post('CHECK_WORLDBOOK_UID',{uid,requestId:id})};
$('btn-add-ct').onclick=()=>{resetAddCt();openM('m-add-ct')};
$('add-ct-ok').onclick=()=>{const uid=addCtState.uid||$('add-uid').value.trim(),name=addCtState.name||$('add-name').value.trim();if(!uid||!name)return;if(D.contacts.contacts.some(c=>c.worldbookUid===uid)){showUidErr('该联络人已存在');return}D.contacts.contacts.push({name,avatar:name[0],color:'#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0'),location:'未知',worldbookUid:uid,messages:[]});saveCt();closeM('m-add-ct');render()};

// 陌路人生成NPC
const genAddCt=(name,info,btn)=>{BtnState.load(btn,'检查中');const id=Req.create('stgwb');Req.set('stgwb',{name,info,btn});post('CHECK_STRANGER_WORLDBOOK',{requestId:id,strangerName:name})};
$('btn-refresh-strangers').onclick=()=>{const btn=$('btn-refresh-strangers');BtnState.load(btn,'');const id=Req.create('extract');Req.set('extract',{btn});post('EXTRACT_STRANGERS',{requestId:id,existingContacts:D.contacts.contacts,existingStrangers:D.contacts.strangers})};

// 世界生成与推演
$('world-gen-ok').onclick=()=>{const btn=$('world-gen-ok'),st=$('world-gen-status');BtnState.load(btn,'生成中');st.style.display='block';st.textContent='正在生成世界数据，请稍候...';const id=Req.create('wgen');post('GENERATE_WORLD',{requestId:id,playerRequests:$('world-gen-req').value.trim()})};
$('world-sim-ok').onclick=()=>{if(!D.meta&&!D.timeline&&!D.maps?.outdoor){alert('请先生成世界数据，再进行推演');return}const btn=$('world-sim-ok'),st=$('world-sim-status');BtnState.load(btn,'推演中');st.style.display='block';st.style.color='#4a9';st.textContent='正在分析玩家行为并推演世界变化...';const id=Req.create('wsim');post('SIMULATE_WORLD',{requestId:id,currentData:JSON.stringify({meta:D.meta,timeline:D.timeline,world:D.world,maps:D.maps},null,2)})};
$('btn-deduce').onclick=()=>openM('m-world-gen');
$('btn-simulate').onclick=()=>openM('m-world-sim');

// 场景切换
$('goto-ok').onclick=()=>{if(!curNode)return;const btn=$('goto-ok'),prev=curLocation||{name:'未知地点',info:''};let tt='sub';if(curNode.type==='main')tt='main';else if(curNode.type==='home')tt='home';const id=Req.create('scene');Req.set('scene',{node:curNode,prev:prev.name});BtnState.load(btn,'生成中');post('SCENE_SWITCH',{requestId:id,prevLocationName:prev.name,prevLocationInfo:prev.info||prev.description||'',targetLocationName:curNode.name,targetLocationType:tt,targetLocationInfo:curNode.info||curNode.description||'',playerAction:$('goto-task').value||''})};

// 保存数据
const saveAll=()=>post('SAVE_ALL_DATA',{allData:{meta:D.meta,timeline:D.timeline,world:D.world,outdoor:D.maps.outdoor,indoor:D.maps.indoor,sceneSetup:D.sceneSetup,strangers:D.contacts.strangers,contacts:D.contacts.contacts}});

// 设置相关
const dataKeys=[['meta','大纲','核心真相、结局逻辑等元数据',()=>D.meta,v=>D.meta=v],['timeline','时间线','世界从当前走向终局的阶段',()=>D.timeline,v=>D.timeline=v],['world','世界资讯','世界新闻、主线进度等信息',()=>D.world,v=>D.world=v],['outdoor','大地图','室外区域的地点和路线',()=>D.maps.outdoor,v=>D.maps.outdoor=v],['indoor','局部地图','室内或局部区域的地点和路线',()=>D.maps.indoor,v=>D.maps.indoor=v],['sceneSetup','区域剧情','当前区域的 Side Story 和表里层结构',()=>D.sceneSetup,v=>D.sceneSetup=v],['strangers','陌路人','已遇见但未建立联系的角色',()=>D.contacts.strangers,v=>D.contacts.strangers=v],['contacts','联络人','已添加的联系人',()=>D.contacts.contacts,v=>D.contacts.contacts=v]];
const promptKeys=[['jsonTemplates','JSON 模板','世界生成/推演/NPC 等 JSON 输出模板合集','templates'],['sms','短信回复','UAUA 短信模拟','prompt'],['summary','总结压缩','新增剧情要素提取','prompt'],['invite','邀请回复','短信邀请场景 UAUA','prompt'],['npc','NPC 生成','陌路人扩写为 NPC','prompt'],['stranger','提取陌路人','从剧情中提取 NPC','prompt'],['worldGen','世界生成（故事模式）','初始世界构建（包含大纲与时间线）','prompt'],['worldSim','世界推演（故事模式）','根据历史演化世界（包含大纲与时间线）','prompt'],['sceneSwitch','场景切换（故事模式）','结算上一地点 + 新场景（包含大纲信息）','prompt'],['worldGenAssist','世界生成（辅助模式）','仅生成地图/新闻等，不写大纲与时间线','prompt'],['worldSimAssist','世界推演（辅助模式）','仅更新地图/新闻等，不动大纲与时间线','prompt'],['sceneSwitchAssist','场景切换（辅助模式）','生成轻松小剧情与局部地图，不涉及大纲','prompt']];
let gSet={apiUrl:'',apiKey:'',model:'',mode:'assist'},dataCk={},editCtx=null,commSet={historyCount:50,npcPosition:0,npcOrder:100},promptSources={},promptTemplates={},promptDefaults={jsonTemplates:{},promptSources:{}};
const reqSet=()=>post('GET_SETTINGS');
const renderDataList=()=>{$('data-list').innerHTML=dataKeys.map(([k,t,d])=>`<div class="data-item ${dataCk[k]?'sel':''}" data-k="${k}"><div class="data-ck"><i class="fa-solid fa-check"></i></div><div class="data-info"><div class="data-nm">${t}</div><div class="data-desc">${d}</div></div><button class="data-edit" data-k="${k}" title="编辑"><i class="fa-solid fa-pen"></i></button></div>`).join('');$$('#data-list .data-item').forEach(i=>i.onclick=e=>{if(e.target.closest('.data-edit'))return;const k=i.dataset.k;dataCk[k]=!dataCk[k];i.classList.toggle('sel',dataCk[k])});$$('#data-list .data-edit').forEach(b=>b.onclick=e=>{e.stopPropagation();openDataEdit(b.dataset.k)})};
const renderPromptList=()=>{$('prompt-list').innerHTML=promptKeys.map(([k,t,d,tp])=>`<div class="data-item" data-k="${k}" data-t="${tp}"><div class="data-ck"><i class="fa-solid fa-pen"></i></div><div class="data-info"><div class="data-nm">${t}</div><div class="data-desc">${d}</div></div><button class="data-edit" data-k="${k}" data-t="${tp}" title="编辑"><i class="fa-solid fa-pen"></i></button></div>`).join('');$$('#prompt-list .data-item').forEach(i=>i.onclick=e=>{const k=i.dataset.k,tp=i.dataset.t;if(!k)return;if(e.target.closest('.data-edit')){e.stopPropagation();openPromptEdit(k,tp);return;}openPromptEdit(k,tp)});$$('#prompt-list .data-edit').forEach(b=>b.onclick=e=>{e.stopPropagation();openPromptEdit(b.dataset.k,b.dataset.t)})};
const unescapePromptStr=s=>String(s||'').replace(/\\\\/g,'\\').replace(/\\t/g,'    ').replace(/\\n/g,'\n');
const updateEditPreview=()=>{const p=$('data-edit-preview');if(!p)return;if(editCtx?.type!=='prompt'){p.style.display='none';p.textContent='';return;}p.style.display='block';const raw=$('data-edit-ta').value||'';let txt=raw;try{const obj=JSON.parse(raw);if(obj&&typeof obj==='object'){txt=Object.entries(obj).map(([k,v])=>`${k}: ${typeof v==='string'?unescapePromptStr(v):typeof v==='object'?JSON.stringify(v,null,2):String(v)}`).join('\n\n');}}catch{txt=unescapePromptStr(raw);}p.textContent=txt};
const setEditContent=(title,val)=>{$('data-edit-title').textContent=title;$('data-edit-ta').value=val;$('data-edit-err').classList.remove('vis');updateEditPreview();openM('m-data-edit')};
const openDataEdit=k=>{const i=dataKeys.find(([x])=>x===k);if(!i)return;editCtx={type:'data',key:k};setEditContent(`编辑 - ${i[1]}`,JSON.stringify(i[3](),null,2))};
const openPromptEdit=(k,tp)=>{const i=promptKeys.find(([x])=>x===k);editCtx={type:'prompt',key:k};const val=tp==='templates'?(promptTemplates||promptDefaults.jsonTemplates||{}):(promptSources[k]||promptDefaults.promptSources[k]||{u1:'',a1:'',u2:'',a2:''});setEditContent(`编辑 - ${i?.[1]||k}`,JSON.stringify(val,null,2))};
$('data-edit-save').onclick=()=>{if(!editCtx)return;try{const parsed=JSON.parse($('data-edit-ta').value);if(editCtx.type==='data'){const i=dataKeys.find(([k])=>k===editCtx.key);if(!i)return;i[4](parsed);render();saveAll()}else if(editCtx.type==='prompt'){if(editCtx.key==='jsonTemplates'){if(!parsed||typeof parsed!=='object'||Array.isArray(parsed))throw new Error('JSON 模板需要是对象');promptTemplates=parsed}else{if(!parsed||typeof parsed!=='object')throw new Error('需要包含 u1/a1/u2/a2 字符串');const need=['u1','a1','u2','a2'];const miss=need.some(k=>typeof parsed?.[k]!=='string');if(miss)throw new Error('需要包含 u1/a1/u2/a2 字符串');promptSources[editCtx.key]=parsed;}renderPromptList();post('SAVE_PROMPTS',{promptConfig:{jsonTemplates:promptTemplates,promptSources}})}closeM('m-data-edit');editCtx=null}catch(e){$('data-edit-err').textContent=`JSON错误: ${e.message}`;$('data-edit-err').classList.add('vis')}};
$('data-edit-ta').addEventListener('input',updateEditPreview);
const showTestRes=(ok,m)=>{const r=$('test-res');r.textContent=m;r.className='set-test-res '+(ok?'ok':'err')};
$('btn-settings').onclick=()=>{reqSet();$('set-api-url').value=gSet.apiUrl||'';$('set-api-key').value=gSet.apiKey||'';$('set-model').value=gSet.model||'';$('set-model-list').style.display='none';$('test-res').className='set-test-res';$('set-stage').value=D.stage||0;$('set-deviation').value=D.deviationScore||0;$('set-mode').value=gSet.mode||'story';$('set-history-count').value=commSet.historyCount||50;$('set-npc-position').value=commSet.npcPosition||0;$('set-npc-order').value=commSet.npcOrder||100;renderDataList();renderPromptList();openM('m-settings')};
$('btn-fetch-models').onclick=()=>{BtnState.load($('btn-fetch-models'),'加载');post('FETCH_MODELS',{apiUrl:$('set-api-url').value.trim(),apiKey:$('set-api-key').value.trim()})};
$('btn-test-conn').onclick=()=>{$('test-res').className='set-test-res';BtnState.load($('btn-test-conn'),'测试');post('TEST_CONNECTION',{apiUrl:$('set-api-url').value.trim(),apiKey:$('set-api-key').value.trim(),model:$('set-model').value.trim()})};
$('set-save').onclick=()=>{gSet={apiUrl:$('set-api-url').value.trim(),apiKey:$('set-api-key').value.trim(),model:$('set-model').value.trim(),mode:$('set-mode').value||'assist'};D.stage=Math.max(0,Math.min(10,parseInt($('set-stage').value,10)||0));D.deviationScore=Math.max(0,Math.min(100,parseInt($('set-deviation').value,10)||0));commSet={historyCount:Math.max(0,Math.min(200,parseInt($('set-history-count').value,10)||50)),npcPosition:parseInt($('set-npc-position').value,10)||0,npcOrder:Math.max(0,Math.min(1000,parseInt($('set-npc-order').value,10)||100))};const od={};dataKeys.forEach(([k,,,get])=>{if(dataCk[k])od[k]=get()});post('SAVE_SETTINGS',{globalSettings:gSet,commSettings:commSet,stage:D.stage,deviationScore:D.deviationScore,dataChecked:dataCk,outlineData:od,allData:{meta:D.meta,timeline:D.timeline,world:D.world,outdoor:D.maps.outdoor,indoor:D.maps.indoor,strangers:D.contacts.strangers,contacts:D.contacts.contacts}});closeM('m-settings')};
$('btn-close').onclick=()=>post('CLOSE_PANEL');

// 消息处理
window.addEventListener('message',e=>{
  if(e.data?.source!=='LittleWhiteBox')return;
  const d=e.data,t=d.type;
  if(t==='LOAD_SETTINGS'){
    if(d.globalSettings)gSet=d.globalSettings;
    if(d.stage!==undefined)D.stage=d.stage;
    if(d.deviationScore!==undefined)D.deviationScore=d.deviationScore;
    if(d.commSettings)commSet={historyCount:d.commSettings.historyCount??50,npcPosition:d.commSettings.npcPosition??0,npcOrder:d.commSettings.npcOrder??100};
    if(d.dataChecked)dataCk=d.dataChecked;
    if(d.promptConfig){promptTemplates=d.promptConfig.current?.jsonTemplates||{};promptSources=d.promptConfig.current?.promptSources||{};promptDefaults=d.promptConfig.defaults||promptDefaults;}
    if(d.outlineData){const o=d.outlineData;if(o.meta)D.meta=o.meta;if(o.timeline)D.timeline=o.timeline;if(o.world)D.world=o.world;if(o.outdoor)D.maps.outdoor=o.outdoor;if(o.indoor)D.maps.indoor=o.indoor;if(o.sceneSetup)D.sceneSetup=o.sceneSetup;if(o.strangers)D.contacts.strangers=o.strangers;if(o.contacts)D.contacts.contacts=o.contacts;render()}
	    if($('m-settings').classList.contains('act')){$('set-api-url').value=gSet.apiUrl||'';$('set-api-key').value=gSet.apiKey||'';$('set-model').value=gSet.model||'';$('set-stage').value=D.stage;$('set-deviation').value=D.deviationScore;$('set-mode').value=gSet.mode||'story';$('set-history-count').value=commSet.historyCount;$('set-npc-position').value=commSet.npcPosition;$('set-npc-order').value=commSet.npcOrder;renderDataList();renderPromptList()}
  }else if(t==='PROMPT_CONFIG_UPDATED'){
    if(d.promptConfig){promptTemplates=d.promptConfig.current?.jsonTemplates||{};promptSources=d.promptConfig.current?.promptSources||{};promptDefaults=d.promptConfig.defaults||promptDefaults;if($('m-settings').classList.contains('act'))renderPromptList()}
  }else if(t==='FETCH_MODELS_RESULT'){
    BtnState.reset($('btn-fetch-models'),'获取');const s=$('set-model-list');
    if(d.error){s.style.display='none';showTestRes(false,'获取模型失败: '+d.error);return}
    if(!d.models?.length){s.style.display='none';showTestRes(false,'未找到可用模型');return}
    s.innerHTML='<option value="">-- 选择模型 --</option>'+d.models.map(m=>`<option value="${m}">${m}</option>`).join('');s.style.display='block';s.onchange=()=>{if(s.value)$('set-model').value=s.value};showTestRes(true,`找到 ${d.models.length} 个模型`)
  }else if(t==='TEST_CONN_RESULT'){BtnState.reset($('btn-test-conn'),'测试连接');showTestRes(d.success,d.message)
  }else if(t==='CHECK_WORLDBOOK_UID_RESULT'){BtnState.reset($('btn-check-uid'),'<i class="fa-solid fa-search"></i> 检查');if(!Req.match(d.requestId))return;if(d.error){showUidErr(d.error);return}if(!d.primaryKeys?.length){showUidErr('该条目没有主要关键字');return}addCtState.keys=d.primaryKeys;const sel=$('add-name');sel.innerHTML='<option value="">-- 请选择 --</option>'+d.primaryKeys.map(k=>`<option value="${k}">${k}</option>`).join('');sel.onchange=()=>{addCtState.name=sel.value;$('add-ct-ok').disabled=!sel.value};$('name-select-group').style.display='block';if(d.primaryKeys.length===1){addCtState.name=d.primaryKeys[0];sel.value=addCtState.name;$('add-ct-ok').disabled=false}
  }else if(t==='SMS_RESULT'){const r=Req.get('sms');if(!r||r.id!==d.requestId)return;Req.clear('sms');smsGen=false;$('chat-in').disabled=$('chat-send').disabled=false;if(!chatTgt)return;chatTgt.messages=chatTgt.messages.filter(m=>!m.typing);if(d.error)chatTgt.messages.push({type:'received',text:`[错误] ${d.error}`});else if(d.reply)chatTgt.messages.push({type:'received',text:stripXml(d.reply)});renderMsgs();saveCt();if(chatTgt.worldbookUid)saveChat(chatTgt)
  }else if(t==='SMS_STREAM'){const r=Req.get('sms');if(!r||r.id!==d.requestId||!chatTgt)return;const tm=chatTgt.messages.find(m=>m.typing);if(tm&&d.text){tm.text=d.text;renderMsgs()}
  }else if(t==='LOAD_SMS_HISTORY_RESULT'){if(!chatTgt||chatTgt.worldbookUid!==d.worldbookUid)return;if(d.messages?.length){chatTgt.messages=d.messages;chatTgt.summarizedCount=d.summarizedCount||0;saveCt()}renderMsgs()
  }else if(t==='COMPRESS_SMS_RESULT'){const r=Req.get('compress');if(!r||r.id!==d.requestId)return;Req.clear('compress');smsGen=false;$('chat-compress').disabled=$('chat-in').disabled=$('chat-send').disabled=false;if(!chatTgt)return;if(d.error){alert(`压缩失败: ${d.error}`);return}if(d.newSummarizedCount!==undefined){chatTgt.summarizedCount=d.newSummarizedCount;renderMsgs();saveCt()}
  }else if(t==='CHECK_STRANGER_WORLDBOOK_RESULT'){const r=Req.get('stgwb');if(!r||r.id!==d.requestId)return;const{name,info,btn}=r;Req.clear('stgwb');if(d.found&&d.worldbookUid){BtnState.reset(btn,'<i class="fa-solid fa-user-plus"></i> 添加');const i=D.contacts.strangers.findIndex(s=>s.name===name);if(i>-1){const st=D.contacts.strangers.splice(i,1)[0];D.contacts.contacts.push({name:st.name,avatar:st.avatar||st.name[0],color:st.color||'#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0'),location:st.location||'未知',info:st.info||'',worldbookUid:d.worldbookUid,messages:[]});saveCt();render()}}else{BtnState.load(btn,'生成中');const id=Req.create('npcgen');Req.set('npcgen',{name,info,btn});post('GENERATE_NPC',{requestId:id,strangerName:name,strangerInfo:info})}
  }else if(t==='GENERATE_NPC_RESULT'){const r=Req.get('npcgen');if(!r||r.id!==d.requestId)return;const{name,btn}=r;Req.clear('npcgen');BtnState.reset(btn,'<i class="fa-solid fa-user-plus"></i> 添加');if(d.error){alert('生成失败: '+d.error);return}if(d.success&&d.worldbookUid){const i=D.contacts.strangers.findIndex(s=>s.name===name);if(i>-1){const st=D.contacts.strangers.splice(i,1)[0],np=d.npcData||{};D.contacts.contacts.push({name:np.name||st.name,avatar:(np.name||st.name)[0],color:st.color||'#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0'),location:st.location||'未知',info:np.intro||st.info||'',worldbookUid:d.worldbookUid,messages:[]});saveCt();render()}}
  }else if(t==='EXTRACT_STRANGERS_RESULT'){const r=Req.get('extract');if(!r||r.id!==d.requestId)return;const{btn}=r;Req.clear('extract');BtnState.reset(btn,'<i class="fa-solid fa-rotate"></i>');if(d.error){alert('提取失败: '+d.error);return}if(d.success&&Array.isArray(d.strangers)){if(!d.strangers.length){alert('没有发现新的陌路人');return}const ex=[...D.contacts.contacts.map(c=>c.name),...D.contacts.strangers.map(s=>s.name)];const nw=d.strangers.filter(s=>!ex.includes(s.name));if(!nw.length){alert('提取的角色都已存在');return}D.contacts.strangers=D.contacts.strangers.concat(nw);saveCt();render();alert(`成功提取 ${nw.length} 个新陌路人`)}
  }else if(t==='GENERATE_WORLD_RESULT'){if(!Req.match(d.requestId))return;Req.clear('wgen');const btn=$('world-gen-ok'),st=$('world-gen-status');BtnState.reset(btn,'<i class="fa-solid fa-wand-magic-sparkles"></i> 开始生成');if(d.error){st.style.color='#c44';st.textContent='生成失败: '+d.error;return}if(d.success&&d.worldData){st.style.color='#4a9';st.textContent='生成成功！正在应用数据...';const wd=d.worldData;if(wd.meta)D.meta=wd.meta;if(wd.timeline)D.timeline=wd.timeline;if(wd.world)D.world=wd.world;if(wd.maps?.outdoor)D.maps.outdoor=wd.maps.outdoor;if(wd.maps?.indoor)D.maps.indoor=wd.maps.indoor;D.stage=0;D.deviationScore=0;saveAll();render();setTimeout(()=>{closeM('m-world-gen');st.style.display='none';$('world-gen-req').value='';alert('世界数据生成完成！Stage 和 Deviation 已重置为 0')},500)}
  }else if(t==='SIMULATE_WORLD_RESULT'){if(!Req.match(d.requestId))return;Req.clear('wsim');const btn=$('world-sim-ok'),st=$('world-sim-status');BtnState.reset(btn,'<i class="fa-solid fa-rotate"></i> 开始推演');if(d.error){st.style.color='#c44';st.textContent='推演失败: '+d.error;return}if(d.success&&d.simData){st.style.color='#4a9';st.textContent='推演成功！正在应用数据...';const sd=d.simData;if(sd.meta)D.meta=sd.meta;if(sd.timeline)D.timeline=sd.timeline;if(sd.world)D.world=sd.world;if(sd.maps?.outdoor)D.maps.outdoor=sd.maps.outdoor;D.stage=(D.stage||0)+1;saveAll();render();setTimeout(()=>{closeM('m-world-sim');st.style.display='none';alert(`世界推演完成！Stage 已推进到 ${D.stage}`)},500)}
  }else if(t==='SCENE_SWITCH_RESULT'){const r=Req.get('scene');if(!r||r.id!==d.requestId)return;const{node,prev}=r;Req.clear('scene');BtnState.reset($('goto-ok'),'确认前往');closeM('m-goto');if(d.error){alert('场景切换失败: '+d.error);return}if(d.success&&d.sceneData){const sc=d.sceneData;if(typeof sc.newScore==='number')D.deviationScore=sc.newScore;if(sc.sideStory)D.sceneSetup={sideStory:sc.sideStory,review:sc.review};if(sc.localMap)D.maps.indoor=sc.localMap;if(sc.strangers?.length){const ex=new Set((D.contacts.strangers||[]).map(s=>s.name));const nw=sc.strangers.filter(s=>!ex.has(s.name));D.contacts.strangers=[...(D.contacts.strangers||[]),...nw]}curLocation=node;const wc=(D.contacts.contacts||[]).filter(c=>c.pendingArrival===node.name);wc.forEach(c=>delete c.pendingArrival);saveAll();render();hideInfo();let sm=`{{user}}离开了${prev||'上一地点'}，来到${node.name}。${$('goto-task').value?'意图：'+$('goto-task').value:''}`;if(wc.length)sm+=`\n${wc.map(c=>c.name).join('、')}已经在这里等你了。`;let sd='';if(sc.review?.deviation?.prev_loc_update)sd+=sc.review.deviation.prev_loc_update+'\n\n';if(sc.localMap?.description)sd+=sc.localMap.description;if(sc.sideStory?.surface)sd+='\n\n'+sc.sideStory.surface;post('EXECUTE_SLASH_COMMAND',{command:`/send ${sm}`,sceneDescription:sd});if(sc.scoreDelta!==0)alert(`场景切换完成！\n偏差值变化: ${sc.scoreDelta>0?'+':''}${sc.scoreDelta} (当前: ${sc.newScore})`)}
  }else if(t==='SEND_INVITE_RESULT'){const r=Req.get('invite');if(!r||r.id!==d.requestId)return;const{contact,loc,btn}=r;Req.clear('invite');BtnState.reset(btn,'发送邀请');if(d.error){alert('邀请失败: '+d.error);return}if(d.success&&d.inviteData){const inv=d.inviteData;contact.messages=contact.messages||[];contact.messages.push({type:'sent',text:`我邀请你前往「${loc}」`});contact.messages.push({type:'received',text:inv.reply});if(inv.accepted){contact.location=loc;if(!inv.sendNow)contact.pendingArrival=loc;alert(`${contact.name} 接受了邀请！\n回复: ${inv.reply}`)}else alert(`${contact.name} 拒绝了邀请。\n回复: ${inv.reply}`);saveCt();if(contact.worldbookUid)saveChat(contact);closeM('m-invite');render();openChat(contact)}}
});

function render(){
  const news=D.world?.news||[];$('news-list').innerHTML=news.length?news.map(n=>`<div class="fold"><div class="fold-h"><div><div class="news-t">${n.title}</div><div class="news-time">${n.time||''}</div></div><i class="fa-solid fa-chevron-down fold-a"></i></div><div class="fold-b news-b"><p>${n.content}</p></div></div>`).join(''):'<div class="empty">暂无新闻</div>';$$('#news-list .fold').forEach(bindFold);
  const prog=D.world?.progress||{percent:0,chapter:'未知'};$('prog-fill').style.width=(prog.percent||0)+'%';$('prog-txt').textContent=`${prog.chapter||'未知'} (${prog.percent||0}%)`;
  const renderCt=(list,isS)=>(list||[]).length?list.map(p=>`<div class="fold" data-name="${p.name||''}" data-info="${(p.info||'').replace(/"/g,'&quot;')}" data-uid="${p.worldbookUid||''}"><div class="fold-h ct-hd fc"><div class="ct-av" style="background:${p.color}">${p.avatar}</div><div class="ct-info"><div class="ct-name">${p.name}</div><div class="ct-st">${p.online?'● 在线':p.location}</div></div><i class="fa-solid fa-chevron-down fold-a"></i></div><div class="fold-b"><div class="ct-det">${p.info?`<div class="ct-info-text">${p.info}</div>`:''}<div class="ct-acts">${isS?`<button class="btn btn-s btn-p fc add-btn" data-name="${p.name||''}" data-info="${(p.info||'').replace(/"/g,'&quot;')}"><i class="fa-solid fa-user-plus"></i> 添加</button><button class="btn btn-s fc ignore-btn" data-name="${p.name||''}"><i class="fa-solid fa-eye-slash"></i> 忽略</button>`:`<button class="btn btn-s fc msg-btn" data-uid="${p.worldbookUid||''}"><i class="fa-solid fa-message"></i> 短信</button><button class="btn btn-s btn-p fc inv-btn" data-uid="${p.worldbookUid||''}"><i class="fa-solid fa-paper-plane"></i> 邀请</button>`}</div></div></div></div>`).join(''):'<div class="empty">暂无</div>';
  $('sec-stranger').innerHTML=renderCt(D.contacts.strangers,true);$('sec-contact').innerHTML=renderCt(D.contacts.contacts,false);$$('.comm-sec .fold').forEach(bindFold);
  $$('.add-btn').forEach(b=>b.onclick=e=>{e.stopPropagation();genAddCt(b.dataset.name,b.dataset.info||'',b)});
  $$('.ignore-btn').forEach(b=>b.onclick=e=>{e.stopPropagation();const i=D.contacts.strangers.findIndex(s=>s.name===b.dataset.name);if(i>-1){D.contacts.strangers.splice(i,1);saveCt();render()}});
  $$('.msg-btn').forEach(b=>b.onclick=e=>{e.stopPropagation();const c=D.contacts.contacts.find(x=>x.worldbookUid===b.dataset.uid);if(c)openChat(c)});
  $$('.inv-btn').forEach(b=>b.onclick=e=>{e.stopPropagation();const c=D.contacts.contacts.find(x=>x.worldbookUid===b.dataset.uid);if(c)openInv(c)});
  const desc=D.maps?.[mapType]?.description||'';$('desc').innerHTML=parseLinks(desc);bindLinks($('desc'));$('mob-desc').innerHTML=parseLinks(desc);bindLinks($('mob-desc'));renderMap()
}

function renderMap(){
  const map=D.maps?.[mapType];seed=123456789;inner.querySelectorAll('.item').forEach(e=>e.remove());svg.innerHTML='';nodes=[];lines=[];if(!map?.nodes?.length)return;
  map.nodes.forEach((n,i)=>{const d=dirMap[n.position]||[0,0],len=Math.hypot(d[0],d[1])||1,dist=(n.distant||1)*120;nodes.push({id:'n'+i,name:n.name,type:n.type||'sub',pos:n.position,distant:n.distant||1,x:d[0]/len*dist,y:d[1]/len*dist,data:n})});
  const groups={};nodes.forEach(n=>(groups[n.pos]=groups[n.pos]||[]).push(n));
  for(let p in groups){const arr=groups[p];if(arr.length<=1)continue;const d=dirMap[p]||[0,0],len=Math.hypot(d[0],d[1])||1,px=-d[1]/len,py=d[0]/len,mid=(arr.length-1)/2;arr.sort((a,b)=>a.distant-b.distant).forEach((n,i)=>{n.x+=px*(i-mid)*50;n.y+=py*(i-mid)*50})}
  for(let t=0;t<15;t++)for(let i=0;i<nodes.length;i++)for(let j=i+1;j<nodes.length;j++){const a=nodes[i],b=nodes[j],dx=a.x-b.x,dy=a.y-b.y,d=Math.hypot(dx,dy);if(d<80&&d>0){const p=(80-d)/d*.5;a.x+=dx*p;a.y+=dy*p;b.x-=dx*p;b.y-=dy*p}}
  nodes.forEach(n=>{const el=document.createElement('div');el.className=`item node-${n.type}`;el.id=n.id;el.textContent=n.type==='home'?'🏠 '+n.name:n.name;el.style.cssText=`left:${n.x+2000}px;top:${n.y+2000}px`;el.onclick=e=>{e.stopPropagation();curNode?.id===n.id?hideInfo():showInfo(n)};inner.appendChild(el)});
  for(let g in groups){const arr=groups[g].sort((a,b)=>a.distant-b.distant);for(let i=0;i<arr.length-1;i++)lines.push([arr[i],arr[i+1]])}
  const anchors=Object.values(groups).map(a=>a.sort((x,y)=>x.distant-y.distant)[0]).sort((a,b)=>Math.atan2(a.y,a.x)-Math.atan2(b.y,b.x));anchors.forEach((a,i)=>lines.push([a,anchors[(i+1)%anchors.length]]));
  const exists=(a,b)=>lines.some(([x,y])=>(x===a&&y===b)||(x===b&&y===a));for(let i=0,c=0;c<Math.floor(nodes.length/5)&&i<200;i++){const a=nodes[Math.floor(rand()*nodes.length)],b=nodes[Math.floor(rand()*nodes.length)];if(a!==b&&!exists(a,b)){lines.push([a,b]);c++}}
  drawLines()
}

function drawLines(){
  svg.innerHTML='';const rect=mapWrap.getBoundingClientRect();
  lines.forEach(([a,b])=>{const elA=$(a.id),elB=$(b.id);if(!elA||!elB)return;const rA=elA.getBoundingClientRect(),rB=elB.getBoundingClientRect(),line=document.createElementNS('http://www.w3.org/2000/svg','line');line.setAttribute('x1',(rA.left+rA.width/2-rect.left)/scale-offX/scale);line.setAttribute('y1',(rA.top+rA.height/2-rect.top)/scale-offY/scale);line.setAttribute('x2',(rB.left+rB.width/2-rect.left)/scale-offX/scale);line.setAttribute('y2',(rB.top+rB.height/2-rect.top)/scale-offY/scale);const main=a.type==='main'&&b.type==='main'||a.type==='home'||b.type==='home';line.setAttribute('stroke',main?'#333':'#aaa');line.setAttribute('stroke-width',main?'2':'1');if(!main)line.setAttribute('stroke-dasharray','4 3');svg.appendChild(line)})
}

const updateTf=()=>{inner.style.transform=`translate(${offX}px,${offY}px) scale(${scale})`;$('zoom-ind').textContent=Math.round(scale*100)+'%';requestAnimationFrame(drawLines)};
const initPos=()=>{offX=-2000+mapWrap.clientWidth/2;offY=-2000+mapWrap.clientHeight/2;scale=1;updateTf()};
function panTo(node,dur=350){if(!node||anim)return;const el=$(node.id);if(!el)return;const tX=-(node.x+2000)*scale+mapWrap.clientWidth/2,tY=-(node.y+2000)*scale+mapWrap.clientHeight*.25,sX=offX,sY=offY,st=performance.now();anim=true;(function step(now){const p=Math.min((now-st)/dur,1),e=1-Math.pow(1-p,3);offX=sX+(tX-sX)*e;offY=sY+(tY-sY)*e;updateTf();p<1?requestAnimationFrame(step):anim=false})(st)}
function showInfo(n){if(!n?.data)return;curNode=n;inner.querySelectorAll('.item').forEach(e=>e.classList.remove('hl'));$(n.id)?.classList.add('hl');mapType==='outdoor'?($('btn-goto').classList.add('show'),$('goto-t').textContent=`前往 ${n.name}`):$('btn-goto').classList.remove('show');if(isMob()){$('mob-info-t').textContent=n.name;$('mob-info-c').textContent=n.data.info||'暂无信息...';popup.classList.add('show-i');if(!popup.classList.contains('act'))openPop(1)}else{$('info-t').textContent=n.name;$('info-c').textContent=n.data.info||'暂无信息...';$('tip').classList.add('show-i')}}
const hideInfo=()=>{curNode=null;inner.querySelectorAll('.item').forEach(e=>e.classList.remove('hl'));$('btn-goto').classList.remove('show');$('tip').classList.remove('show-i');popup.classList.remove('show-i')};
$('info-bk').onclick=hideInfo;$('mob-info-bk').onclick=()=>popup.classList.remove('show-i');

let sx,sy,lastDist=0,lastCX=0,lastCY=0;
mapWrap.onmousedown=e=>{if(anim||e.target.closest('.map-act,.map-lbl'))return;if(!e.target.classList.contains('item'))hideInfo();drag=true;sx=e.clientX;sy=e.clientY;mapWrap.style.cursor='grabbing'};
mapWrap.onmousemove=e=>{if(!drag)return;offX+=e.clientX-sx;offY+=e.clientY-sy;sx=e.clientX;sy=e.clientY;updateTf()};
mapWrap.onmouseup=mapWrap.onmouseleave=()=>{drag=false;mapWrap.style.cursor='grab'};
mapWrap.onwheel=e=>{if(anim)return;e.preventDefault();const ns=Math.max(.3,Math.min(3,scale+(e.deltaY>0?-.1:.1))),rect=mapWrap.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top,r=ns/scale;offX=mx-(mx-offX)*r;offY=my-(my-offY)*r;scale=ns;updateTf()};
mapWrap.ontouchstart=e=>{if(anim||e.target.closest('.map-act,.map-lbl'))return;const it=e.target.closest('.item');if(it){it._ts={x:e.touches[0].clientX,y:e.touches[0].clientY,t:Date.now()};return}hideInfo();if(e.touches.length===1){drag=true;sx=e.touches[0].clientX;sy=e.touches[0].clientY}else if(e.touches.length===2){drag=false;lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);lastCX=(e.touches[0].clientX+e.touches[1].clientX)/2;lastCY=(e.touches[0].clientY+e.touches[1].clientY)/2}};
mapWrap.ontouchmove=e=>{const it=e.target.closest('.item');if(it&&it._ts){const dx=e.touches[0].clientX-it._ts.x,dy=e.touches[0].clientY-it._ts.y;if(Math.hypot(dx,dy)>10){delete it._ts;drag=true;sx=e.touches[0].clientX;sy=e.touches[0].clientY}return}if(e.touches.length===1&&drag){offX+=e.touches[0].clientX-sx;offY+=e.touches[0].clientY-sy;sx=e.touches[0].clientX;sy=e.touches[0].clientY;updateTf()}else if(e.touches.length===2){const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY),cx=(e.touches[0].clientX+e.touches[1].clientX)/2,cy=(e.touches[0].clientY+e.touches[1].clientY)/2,ns=Math.max(.3,Math.min(3,scale*(d/lastDist))),rect=mapWrap.getBoundingClientRect(),mx=cx-rect.left,my=cy-rect.top,r=ns/scale;offX=mx-(mx-offX)*r;offY=my-(my-offY)*r;offX+=cx-lastCX;offY+=cy-lastCY;scale=ns;lastDist=d;lastCX=cx;lastCY=cy;updateTf()}};
mapWrap.ontouchend=e=>{const it=e.target.closest('.item');if(it&&it._ts){const el=Date.now()-it._ts.t;delete it._ts;if(el<300){const n=nodes.find(n=>n.id===it.id);if(n){e.preventDefault();curNode?.id===n.id?hideInfo():showInfo(n)}}}drag=false};
$$('.nav-i').forEach(i=>i.onclick=()=>{$$('.nav-i').forEach(n=>n.classList.remove('act'));$$('.page').forEach(p=>p.classList.remove('act'));i.classList.add('act');$(`page-${i.dataset.p}`).classList.add('act');$('map-tog').classList.toggle('show',i.dataset.p==='map');if(isMob())i.dataset.p==='map'?openPop(1):popup.classList.remove('act');if(i.dataset.p==='map')setTimeout(()=>{initPos();drawLines()},50)});
$$('.comm-tab').forEach(t=>t.onclick=()=>{$$('.comm-tab').forEach(x=>x.classList.remove('act'));$$('.comm-sec').forEach(s=>s.classList.remove('act'));t.classList.add('act');$(`sec-${t.dataset.t}`).classList.add('act')});
$('btn-tog').onclick=()=>{mapType=mapType==='outdoor'?'indoor':'outdoor';$('btn-tog').innerHTML=mapType==='outdoor'?'<i class="fa-solid fa-expand"></i>':'<i class="fa-solid fa-compress"></i>';$('btn-tog').classList.toggle('in',mapType==='indoor');$('map-lbl-t').textContent=D.maps[mapType].name;render();hideInfo();initPos()};
$('btn-goto').onclick=e=>{e.stopPropagation();if(curNode){$('goto-d').textContent=`目的地：${curNode.name}`;$('goto-task').value='';openM('m-goto')}};
addEventListener('resize',()=>requestAnimationFrame(drawLines));
document.addEventListener('DOMContentLoaded',()=>{render();initPos();if(isMob())openPop(1);post('FRAME_READY')});
</script>
</body>
</html>
